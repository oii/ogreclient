#! /bin/bash -e
#
# Ogreclient install script for OSX and linux
#

OGRE_HOST=${OGRE_HOST:-https://ogre-staging.oii.yt}

trap "echo Exited!; exit;" SIGINT SIGTERM

red=$(tput setaf 1)
green=$(tput setaf 2)
white=$(tput setaf 7)
reset=$(tput sgr0)

function install_homebrew {
  if ! command -v brew >/dev/null 2>&1; then
    echo "${white}==> Installing Homebrew${reset}"
    ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  fi
}

# optionally install into a virtualenv
if [[ $1 == --venv ]]; then
  if [[ ! -z $2 ]]; then
    VENV=$2
  else
    VENV=ogreclient
  fi
else
  VENV=''
fi

if [[ $(uname) =~ (.*)Darwin(.*) ]]; then
  install_homebrew

  if ! command pip &>/dev/null; then
    echo "${white}==> Installing/Updating Python${reset}"
    brew install python
  fi

  if ! command ebook-meta &>/dev/null; then
    echo "${white}==> Installing Calibre${reset}"
    brew cask install calibre
  fi

  if [[ ! -z $VENV ]]; then
    # create a venv if it does not exist
    if [[ ! -d "$HOME/.virtualenvs/$VENV/bin" ]]; then
      echo "${white}==> Installing virtualenv:${reset}"
      pip install virtualenv
      echo "${white}==> Creating a virtualenv:${reset}"
      mkdir ~/.virtualenvs
      virtualenv ~/.virtualenvs/$VENV
    fi

    # shellcheck source=/dev/null
    source ~/.virtualenvs/$VENV/bin/activate
  fi

  echo "${white}==> Upgrading pip:${reset}"
  pip install -U pip

  echo "${white}==> Installing OGRE from ${OGRE_HOST}:${reset}"
  curl -o /tmp/ogreclient.zip -L -k "$OGRE_HOST/download/ogreclient"
  pip install -U /tmp/ogreclient.zip

  if [[ -z $(system_profiler SPApplicationsDataType | awk '/Kindle.app/ {print $2}') ]]; then
    echo "${white}==> Kindle for Mac is missing:${reset}"
    brew cask install kindle
  fi

  if ! ls /Applications/BitBar* >/dev/null 2>&1; then
    echo "${white}==> Installing BitBar for Mac:${reset}"
    cd /tmp
    curl -o BitBarDistro.zip -L -k "$OGRE_HOST/download/bitbar"
    unzip -q -o BitBarDistro.zip
    rsync -a /tmp/BitBarDistro.app/ /Applications/BitBarDistro.app
    rm -rf BitBarDistro.zip BitBarDistro.app
  fi

  echo "${green}==> OGRE install complete${reset}"
  echo ''

  # open Kindle for Mac on first run
  if [[ ! -d ~/.config/ogre ]]; then
    open --background /Applications/Kindle.app
  fi

elif [[ $(uname) =~ (.*)Debian(.*) ]]; then
  echo "${red}Not implemented for Debian${reset}"
  exit 1

elif [[ $(uname) =~ (.*)Ubuntu(.*) ]]; then
  echo "${red}Not implemented for Ubuntu${reset}"
  exit 1

fi
